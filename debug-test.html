<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ğŸ”§ AI å®¢æœç³»çµ±è¨ºæ–·å·¥å…·</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1F2A44 0%, #0e1322 100%);
      color: #e6e6eb;
      padding: 20px;
      min-height: 100vh;
    }
    .container { max-width: 1000px; margin: 0 auto; }
    h1 { margin-bottom: 10px; color: #F2E2A2; }
    .subtitle { color: #7B7289; margin-bottom: 30px; }
    .test-section {
      background: rgba(255,255,255,0.05);
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 8px;
      border: 1px solid rgba(123,114,137,0.2);
    }
    h2 { color: #F2E2A2; margin-bottom: 15px; font-size: 1.1rem; }
    .test-item {
      padding: 12px;
      margin-bottom: 10px;
      border-left: 3px solid #7B7289;
      background: rgba(0,0,0,0.2);
      border-radius: 4px;
    }
    .test-item strong { color: #F2E2A2; }
    .status {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 10px;
    }
    .status.ok { background: #28a745; color: white; }
    .status.error { background: #dc3545; color: white; }
    .status.pending { background: #ffc107; color: #000; }
    .status.warning { background: #fd7e14; color: white; }
    button {
      background: #F2E2A2;
      color: #1F2A44;
      border: none;
      padding: 10px 20px;
      border-radius: 6px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      margin-right: 10px;
      margin-bottom: 10px;
    }
    button:hover { background: #ffedb3; transform: translateY(-2px); }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .output {
      background: rgba(0,0,0,0.5);
      padding: 15px;
      border-radius: 6px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
      font-family: 'Courier New', monospace;
      font-size: 12px;
    }
    .line { margin-bottom: 5px; }
    .log-error { color: #ff6b6b; }
    .log-success { color: #51cf66; }
    .log-info { color: #74c0fc; }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ”§ AI å®¢æœç³»çµ±è¨ºæ–·å·¥å…·</h1>
    <p class="subtitle">ç”¨æ–¼æª¢æŸ¥ API é€£æ¥å’Œèª¿è©¦å•é¡Œ</p>

    <!-- ç’°å¢ƒæª¢æŸ¥ -->
    <div class="test-section">
      <h2>ğŸ“‹ ç’°å¢ƒæª¢æŸ¥</h2>
      <div id="env-info"></div>
      <button onclick="runFullDiagnostics()">åŸ·è¡Œå®Œæ•´è¨ºæ–·</button>
    </div>

    <!-- é€£æ¥æ¸¬è©¦ -->
    <div class="test-section">
      <h2>ğŸ”Œ é€£æ¥æ¸¬è©¦</h2>
      <button onclick="testHealth()">æ¸¬è©¦ /api/health</button>
      <button onclick="testChatEndpoint()">æ¸¬è©¦ /api/chat ç«¯é»</button>
      <button onclick="testFullChat()">å®Œæ•´èŠå¤©æ¸¬è©¦</button>
      <div id="connect-output" class="output" style="display:none;"></div>
    </div>

    <!-- è©³ç´°æ—¥èªŒ -->
    <div class="test-section">
      <h2>ğŸ“Š è©³ç´°è¨ºæ–·æ—¥èªŒ</h2>
      <button onclick="clearLogs()">æ¸…ç©ºæ—¥èªŒ</button>
      <div id="logs" class="output"></div>
    </div>
  </div>

  <script>
    const apiBase = window.location.hostname === 'localhost' 
      ? 'http://localhost:3000'
      : window.location.origin

    function log(message, type = 'info') {
      const logsEl = document.getElementById('logs')
      const line = document.createElement('div')
      line.className = `line log-${type}`
      const timestamp = new Date().toLocaleTimeString('zh-TW')
      line.textContent = `[${timestamp}] ${message}`
      logsEl.appendChild(line)
      logsEl.scrollTop = logsEl.scrollHeight
    }

    function clearLogs() {
      document.getElementById('logs').innerHTML = ''
      log('æ—¥èªŒå·²æ¸…ç©º', 'info')
    }

    function showOutput(elementId, content, type = 'info') {
      const el = document.getElementById(elementId)
      el.style.display = 'block'
      el.innerHTML = ''
      const line = document.createElement('div')
      line.className = `line log-${type}`
      line.textContent = content
      el.appendChild(line)
    }

    // ç’°å¢ƒä¿¡æ¯
    function displayEnvInfo() {
      const envEl = document.getElementById('env-info')
      envEl.innerHTML = `
        <div class="test-item">
          <strong>ç•¶å‰ URL:</strong> ${window.location.href}
        </div>
        <div class="test-item">
          <strong>API åŸºç¤:</strong> ${apiBase}
        </div>
        <div class="test-item">
          <strong>User Agent:</strong> ${navigator.userAgent.substring(0, 50)}...
        </div>
        <div class="test-item">
          <strong>æ™‚é–“:</strong> ${new Date().toLocaleString('zh-TW')}
        </div>
      `
    }

    // æ¸¬è©¦ Health Check
    async function testHealth() {
      log('é–‹å§‹æ¸¬è©¦ /api/health...', 'info')
      try {
        const startTime = performance.now()
        const response = await fetch(`${apiBase}/api/health`)
        const elapsed = (performance.now() - startTime).toFixed(2)
        
        log(`HTTP ç‹€æ…‹: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error')
        log(`éŸ¿æ‡‰æ™‚é–“: ${elapsed}ms`, 'info')
        
        const data = await response.json()
        log(`å›æ‡‰: ${JSON.stringify(data)}`, 'success')
        
        showOutput('connect-output', `âœ… Health Check æˆåŠŸ!\n\n${JSON.stringify(data, null, 2)}`, 'success')
      } catch (err) {
        log(`âŒ éŒ¯èª¤: ${err.message}`, 'error')
        showOutput('connect-output', `âŒ éŒ¯èª¤: ${err.message}`, 'error')
      }
    }

    // æ¸¬è©¦ Chat ç«¯é»çµæ§‹
    async function testChatEndpoint() {
      log('é–‹å§‹æ¸¬è©¦ /api/chat ç«¯é»...', 'info')
      try {
        const payload = {
          messages: [{ role: 'user', content: 'æ¸¬è©¦' }],
          model: 'google/gemma-3-27b-it:free'
        }
        log(`ç™¼é€ payload: ${JSON.stringify(payload)}`, 'info')
        
        const response = await fetch(`${apiBase}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(payload)
        })
        
        log(`HTTP ç‹€æ…‹: ${response.status}`, response.ok ? 'success' : 'error')
        
        const contentType = response.headers.get('content-type')
        log(`Content-Type: ${contentType}`, 'info')
        
        const responseText = await response.text()
        log(`åŸå§‹å›æ‡‰é•·åº¦: ${responseText.length} å­—å…ƒ`, 'info')
        
        if (responseText.length > 0) {
          log(`å›æ‡‰å‰ 100 å­—å…ƒ: ${responseText.substring(0, 100)}`, 'info')
          
          try {
            const data = JSON.parse(responseText)
            log(`âœ… JSON è§£ææˆåŠŸ`, 'success')
            log(`å›æ‡‰çµæ§‹: ${JSON.stringify(data, null, 2).substring(0, 200)}`, 'success')
            showOutput('connect-output', `âœ… Chat ç«¯é»æ­£å¸¸\n\n${JSON.stringify(data, null, 2)}`, 'success')
          } catch (parseErr) {
            log(`âŒ JSON è§£æå¤±æ•—: ${parseErr.message}`, 'error')
            showOutput('connect-output', `âŒ ä¼ºæœå™¨è¿”å›ç„¡æ•ˆ JSON\n\n${responseText.substring(0, 500)}`, 'error')
          }
        } else {
          log(`âŒ ç©ºå›æ‡‰`, 'error')
          showOutput('connect-output', `âŒ ä¼ºæœå™¨è¿”å›ç©ºå›æ‡‰`, 'error')
        }
      } catch (err) {
        log(`âŒ ç¶²è·¯éŒ¯èª¤: ${err.message}`, 'error')
        showOutput('connect-output', `âŒ ç„¡æ³•é€£æ¥åˆ°ä¼ºæœå™¨: ${err.message}`, 'error')
      }
    }

    // å®Œæ•´èŠå¤©æ¸¬è©¦
    async function testFullChat() {
      log('é–‹å§‹å®Œæ•´èŠå¤©æ¸¬è©¦...', 'info')
      try {
        const message = 'è«‹ç°¡çŸ­ä»‹ç´¹ä½ è‡ªå·±'
        log(`ç™¼é€è¨Šæ¯: "${message}"`, 'info')
        
        const response = await fetch(`${apiBase}/api/chat`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            messages: [{ role: 'user', content: message }],
            model: 'google/gemma-3-27b-it:free'
          })
        })
        
        log(`æ”¶åˆ°å›æ‡‰ (HTTP ${response.status})`, 'info')
        
        const responseText = await response.text()
        let data
        
        try {
          data = JSON.parse(responseText)
          log(`âœ… JSON è§£ææˆåŠŸ`, 'success')
        } catch (e) {
          log(`âŒ JSON è§£æå¤±æ•—`, 'error')
          throw new Error('Invalid JSON response')
        }
        
        if (!response.ok || !data.ok) {
          log(`âš ï¸ ä¼ºæœå™¨éŒ¯èª¤: ${data.error}`, 'warning')
          showOutput('connect-output', `âš ï¸ ä¼ºæœå™¨è¿”å›éŒ¯èª¤:\n${data.error}`, 'warning')
        } else {
          // å˜—è©¦æå– AI å›æ‡‰
          let aiReply = 'ç„¡æ³•è§£æå›æ‡‰'
          if (data.response?.choices?.[0]?.message?.content) {
            aiReply = data.response.choices[0].message.content
          } else if (data.response?.content) {
            aiReply = data.response.content
          } else if (typeof data.response === 'string') {
            aiReply = data.response
          }
          
          log(`âœ… AI å›æ‡‰: ${aiReply.substring(0, 50)}...`, 'success')
          showOutput('connect-output', `âœ… å®Œæ•´èŠå¤©æ¸¬è©¦æˆåŠŸ!\n\nAI å›æ‡‰:\n${aiReply}`, 'success')
        }
      } catch (err) {
        log(`âŒ éŒ¯èª¤: ${err.message}`, 'error')
        showOutput('connect-output', `âŒ éŒ¯èª¤: ${err.message}`, 'error')
      }
    }

    // åŸ·è¡Œå®Œæ•´è¨ºæ–·
    async function runFullDiagnostics() {
      log('========== é–‹å§‹å®Œæ•´è¨ºæ–· ==========', 'info')
      log(`API Base: ${apiBase}`, 'info')
      
      // æª¢æŸ¥å¾Œç«¯æœå‹™
      log('1ï¸âƒ£  æª¢æŸ¥å¾Œç«¯æœå‹™...', 'info')
      try {
        const response = await fetch(`${apiBase}/api/health`, { method: 'GET' })
        if (response.ok) {
          log('âœ… å¾Œç«¯æœå‹™æ­£å¸¸é‹è¡Œ', 'success')
        } else {
          log(`âš ï¸ å¾Œç«¯æœå‹™ç•°å¸¸ (HTTP ${response.status})`, 'warning')
        }
      } catch (err) {
        log(`âŒ ç„¡æ³•é€£æ¥åˆ°å¾Œç«¯ (${err.message})`, 'error')
      }
      
      // æª¢æŸ¥ç’°å¢ƒè®Šæ•¸
      log('2ï¸âƒ£  æª¢æŸ¥ç’°å¢ƒè®Šæ•¸...', 'info')
      log('âš ï¸ ç„¡æ³•åœ¨å‰ç«¯æª¢æŸ¥å¾Œç«¯ç’°å¢ƒè®Šæ•¸ï¼Œè«‹åœ¨å¾Œç«¯ä¼ºæœå™¨æ—¥èªŒä¸­æª¢æŸ¥', 'warning')
      
      // æ¸¬è©¦ API ç«¯é»
      log('3ï¸âƒ£  æ¸¬è©¦ API ç«¯é»...', 'info')
      await testChatEndpoint()
      
      log('========== è¨ºæ–·å®Œæˆ ==========', 'info')
    }

    // é é¢è¼‰å…¥
    window.addEventListener('load', () => {
      displayEnvInfo()
      log('è¨ºæ–·å·¥å…·å·²æº–å‚™å°±ç·’', 'success')
    })
  </script>
</body>
</html>
