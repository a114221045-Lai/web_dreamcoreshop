# ğŸ” AI å®¢æœç³»çµ± - JSON éŒ¯èª¤è¨ºæ–·æŒ‡å—

## å•é¡Œæè¿°
ç”¨æˆ¶å ±å‘ŠéŒ¯èª¤ï¼š`ç•°å¸¸ï¼šUnexpected token 'T', "The page c"... is not valid JSON`

é€™å€‹éŒ¯èª¤é€šå¸¸è¡¨ç¤ºå‰ç«¯æ”¶åˆ°çš„ä¸æ˜¯æœ‰æ•ˆçš„ JSONï¼Œè€Œæ˜¯ HTML æˆ–å…¶ä»–æ–‡æœ¬å…§å®¹ã€‚

## æ ¹æœ¬åŸå› 

### å¸¸è¦‹åŸå› ï¼š
1. **å¾Œç«¯æœå‹™æœªé‹è¡Œ** - å°è‡´ 404 é é¢è¿”å› HTML
2. **API ç«¯é»è¿”å› HTML è€Œé JSON** - è·¯ç”±å•é¡Œ
3. **CORS éŒ¯èª¤** - ç€è¦½å™¨å®‰å…¨é™åˆ¶
4. **ç’°å¢ƒè®Šæ•¸æœªè¨­ç½®** - API Key ç¼ºå¤±å°è‡´ 500 éŒ¯èª¤
5. **JSON è§£æç•°å¸¸æœªè¢«æ•æ‰** - `response.json()` æ‹‹ç•°å¸¸

## ä¿®å¾©æ¸…å–®

### âœ… å·²å®Œæˆçš„ä¿®å¾©

#### 1. æ”¹é€²å‰ç«¯éŒ¯èª¤è™•ç† ([script.js](script.js#L100-L160))
- ä½¿ç”¨ `response.text()` å…ˆè®€å–åŸå§‹å›æ‡‰
- æ‰‹å‹• `JSON.parse()` ä¸¦æ•æ‰ç•°å¸¸
- é¡¯ç¤ºå¯¦éš›æ”¶åˆ°çš„å›æ‡‰å…§å®¹ï¼ˆå‰ 200 å­—å…ƒï¼‰
- æ·»åŠ è©³ç´°çš„ debug æ—¥èªŒ

**æ”¹é€²å‰ï¼š**
```javascript
const data = await response.json()  // âŒ æœƒæ‹‹ç•°å¸¸ä½†æœªè¢«é©ç•¶æ•æ‰
```

**æ”¹é€²å¾Œï¼š**
```javascript
const responseText = await response.text()
try {
  data = JSON.parse(responseText)
} catch (parseErr) {
  // è©³ç´°çš„éŒ¯èª¤ä¿¡æ¯å’ŒåŸå§‹å›æ‡‰
}
```

#### 2. æ”¹é€²å¾Œç«¯ API è·¯ç”± ([server.js](backend/server.js#L35-L60))
- æ·»åŠ  `Content-Type: application/json` æ˜ç¢ºè¨­ç½®
- æ”¹é€²éŒ¯èª¤å †æ£§æ—¥èªŒ
- ä¿®å¾©è·¯ç”±é †åºï¼Œç¢ºä¿ SPA 404 æ•æ‰ä¸å½±éŸ¿ API

**ä¸»è¦æ”¹è®Šï¼š**
```javascript
res.setHeader('Content-Type', 'application/json; charset=utf-8')
res.status(500).json({ ok: false, error: errMsg })
```

#### 3. ä¿®å¾© SDK å°å…¥ ([ORAPI.js](backend/ORAPI.js#L6))
- å¾ `const { OpenRouter } = require()` æ”¹ç‚ºç›´æ¥å°å‡º
- ä½¿ç”¨ `client.chat.completions.create()` è€Œé `.send()`

## è¨ºæ–·æ­¥é©Ÿ

### 1ï¸âƒ£ æª¢æŸ¥å¾Œç«¯æ˜¯å¦é‹è¡Œ
```bash
cd ç¶²ç«™ä½œæ¥­
npm start
# æ‡‰è©²çœ‹åˆ°: ğŸš€ Backend API listening on http://localhost:3000
```

### 2ï¸âƒ£ ä½¿ç”¨è¨ºæ–·å·¥å…·
è¨ªå• `http://localhost:3000/debug-test.html`
- æ¸¬è©¦ `/api/health` - æª¢æŸ¥é€£æ¥
- æ¸¬è©¦ `/api/chat` - æª¢æŸ¥ç«¯é»
- åŸ·è¡Œå®Œæ•´è¨ºæ–·

### 3ï¸âƒ£ æª¢æŸ¥ç€è¦½å™¨æ§åˆ¶å°æ—¥èªŒ
æŒ‰ F12 æ‰“é–‹é–‹ç™¼è€…å·¥å…·ï¼ŒæŸ¥çœ‹ï¼š
```
[Chat] ç™¼é€è«‹æ±‚åˆ°: http://localhost:3000/api/chat
[Chat] HTTP ç‹€æ…‹: 200
[Chat] Content-Type: application/json; charset=utf-8
[Chat] åŸå§‹å›æ‡‰ (å‰ 200 å­—å…ƒ): ...
```

### 4ï¸âƒ£ æª¢æŸ¥å¾Œç«¯æ—¥èªŒ
å¾Œç«¯æœå‹™å™¨æ‡‰è©²é¡¯ç¤ºï¼š
```
[2025-12-18T...] Chat request: { messageCount: 1, model: 'google/gemma-3-27b-it:free' }
[ORAPI] æº–å‚™ç™¼é€è«‹æ±‚åˆ° google/gemma-3-27b-it:free
[ORAPI] æ”¶åˆ°å›æ‡‰ï¼Œè™•ç†ä¸­...
[2025-12-18T...] Chat response received, type: object
```

## å¯èƒ½çš„å•é¡Œèˆ‡è§£æ±ºæ–¹æ¡ˆ

### å•é¡Œ 1: "The page c... is not valid JSON"
**åŸå› ï¼š** æ”¶åˆ°äº† HTML 404 é é¢è€Œé JSON

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. ç¢ºèªå¾Œç«¯é‹è¡Œï¼š`npm start`
2. æª¢æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ `OPENROUTER_API_KEY`
3. æŸ¥çœ‹å¾Œç«¯æ—¥èªŒçœ‹æ˜¯å¦æœ‰å †æ£§éŒ¯èª¤

### å•é¡Œ 2: "API é‡‘é‘°èªè­‰å¤±æ•—"
**åŸå› ï¼š** `.env` ä¸­ API Key ä¸æ­£ç¢ºæˆ–æœªè¨­ç½®

**è§£æ±ºæ–¹æ¡ˆï¼š**
```bash
# æª¢æŸ¥ .env æ–‡ä»¶
cat ç¶²ç«™ä½œæ¥­/.env

# ç¢ºä¿æœ‰æ­£ç¢ºçš„ API Keyï¼š
OPENROUTER_API_KEY=sk-or-v1-...
```

### å•é¡Œ 3: "ç„¡æ³•é€£æ¥åˆ° OpenRouter API"
**åŸå› ï¼š** ç¶²è·¯å•é¡Œæˆ– OpenRouter æœå‹™ä¸å¯ç”¨

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. æª¢æŸ¥ç¶²çµ¡é€£æ¥
2. è¨ªå• https://openrouter.ai é©—è­‰æœå‹™ç‹€æ…‹
3. æŸ¥çœ‹å¾Œç«¯é‡è©¦æ—¥èªŒ

### å•é¡Œ 4: èŠå¤©æ¡†é¡¯ç¤ºç©ºå›æ‡‰
**åŸå› ï¼š** OpenRouter è¿”å›æ ¼å¼èˆ‡é æœŸä¸ç¬¦

**è§£æ±ºæ–¹æ¡ˆï¼š**
1. ä½¿ç”¨ debug-test.html æª¢æŸ¥å®Œæ•´ JSON çµæ§‹
2. æŸ¥çœ‹ `data.response` çš„å¯¦éš›çµæ§‹
3. å¦‚éœ€è¦ï¼Œåœ¨ script.js ä¸­æ·»åŠ æ–°çš„è§£ææ ¼å¼

## æ–‡ä»¶æ¸…å–®

ä¿®å¾©æ¶‰åŠçš„æ–‡ä»¶ï¼š
- âœ… `ç¶²ç«™ä½œæ¥­/script.js` - æ”¹é€²å‰ç«¯éŒ¯èª¤è™•ç†
- âœ… `ç¶²ç«™ä½œæ¥­/backend/server.js` - æ”¹é€²å¾Œç«¯ API éŸ¿æ‡‰
- âœ… `ç¶²ç«™ä½œæ¥­/backend/ORAPI.js` - ä¿®å¾© SDK å°å…¥
- âœ… `ç¶²ç«™ä½œæ¥­/debug-test.html` - æ–°å¢è¨ºæ–·å·¥å…·

## ä¸‹ä¸€æ­¥

1. **æ¸¬è©¦ä¿®å¾©**ï¼š
   - é‹è¡Œ `npm start`
   - è¨ªå•ä¸»é é¢ï¼Œä½¿ç”¨èŠå¤©åŠŸèƒ½
   - æŸ¥çœ‹æµè§ˆå™¨æ§åˆ¶å°æ˜¯å¦æœ‰è©³ç´°æ—¥èªŒ

2. **é©—è­‰ API Key**ï¼š
   - ç¢ºèª `.env` ä¸­æœ‰æœ‰æ•ˆçš„ API Key
   - åœ¨ debug-test.html ä¸­æ¸¬è©¦é€£æ¥

3. **æäº¤æ—¥èªŒ**ï¼š
   - å¦‚ä»æœ‰å•é¡Œï¼Œæ”¶é›†ï¼š
     - ç€è¦½å™¨æ§åˆ¶å°æ—¥èªŒ
     - å¾Œç«¯æœå‹™å™¨æ—¥èªŒ
     - å®Œæ•´çš„éŒ¯èª¤è¨Šæ¯
